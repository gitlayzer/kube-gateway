# Kube-Gateway

![Go Version](https://img.shields.io/badge/Go-1.24+-00ADD8?style=for-the-badge&logo=go)
![Build Status](https://img.shields.io/badge/Build-Passing-brightgreen?style=for-the-badge)

**ä¸€ä¸ªé›†ä¸­çš„ã€é›¶é…ç½®çš„ Kubernetes API ç½‘å…³ï¼Œæ—¨åœ¨ç®€åŒ–å¤šé›†ç¾¤ç®¡ç†ã€‚**

---

`Kube-Gateway` æä¾›ä¸€ä¸ªç»Ÿä¸€ã€å®‰å…¨çš„ API å…¥å£ï¼Œè®©å¼€å‘è€…å’Œè¿ç»´äººå‘˜å¯ä»¥ä½¿ç”¨å•ä¸€çš„ã€è‡ªåŠ¨ç®¡ç†çš„ `kubeconfig` æ–‡ä»¶ï¼Œæ— ç¼åœ°è®¿é—®å’Œæ“ä½œæ‰€æœ‰å·²æˆæƒçš„ Kubernetes é›†ç¾¤ã€‚

## ç›®å½•

- [èƒŒæ™¯](#èƒŒæ™¯)
- [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
- [æ¶æ„ç®€å›¾](#æ¶æ„ç®€å›¾)
- [å®‰è£…](#å®‰è£…)
- [è¯¦ç»†ä½¿ç”¨ä¸æµ‹è¯•æŒ‡å— (Linux)](#è¯¦ç»†ä½¿ç”¨ä¸æµ‹è¯•æŒ‡å—-linux)
- [å‘½ä»¤è¯¦è§£](#å‘½ä»¤è¯¦è§£)

## èƒŒæ™¯

éšç€äº‘åŸç”ŸæŠ€æœ¯çš„å‘å±•ï¼Œåœ¨å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨æ•°åä¸ªç”šè‡³ä¸Šç™¾ä¸ª Kubernetes é›†ç¾¤å·²æˆä¸ºå¸¸æ€ã€‚ç®¡ç†è¿™äº›é›†ç¾¤çš„è®¿é—®å‡­è¯ (`kubeconfig`) å˜å¾—æ—¥ç›Šå¤æ‚å’Œæ··ä¹±ï¼š
- å¼€å‘è€…éœ€è¦åœ¨æœ¬åœ°ç»´æŠ¤å¤§é‡é…ç½®æ–‡ä»¶ã€‚
- è½®æ¢å¯†é’¥å’Œæ›´æ–°å‡­è¯æˆä¸ºä¸€é¡¹ç¹é‡ä¸”æ˜“é”™çš„ä»»åŠ¡ã€‚
- æ— æ³•å¯¹æ‰€æœ‰é›†ç¾¤çš„è®¿é—®è¿›è¡Œç»Ÿä¸€çš„å®¡è®¡å’Œæ§åˆ¶ã€‚

`Kube-Gateway` çš„è¯ç”Ÿå°±æ˜¯ä¸ºäº†è§£å†³è¿™äº›ç—›ç‚¹ã€‚

## æ ¸å¿ƒç‰¹æ€§

- **ğŸš€ ç»Ÿä¸€è®¿é—®å…¥å£**: æ‰€æœ‰ `kubectl` è¯·æ±‚éƒ½æŒ‡å‘åŒä¸€ä¸ªç½‘å…³åœ°å€ï¼Œç”±ç½‘å…³æ™ºèƒ½è·¯ç”±åˆ°åç«¯å¯¹åº”çš„é›†ç¾¤ã€‚
- **âš™ï¸ é›¶é…ç½®å¯åŠ¨**: é¦–æ¬¡å¯åŠ¨æœåŠ¡æ—¶ï¼Œè‡ªåŠ¨ç”Ÿæˆæ‰€éœ€çš„ TLS è¯ä¹¦ï¼Œæ— éœ€ä»»ä½•æ‰‹åŠ¨ `openssl` æ“ä½œã€‚
- **ğŸ¤ å®¢æˆ·ç«¯æ— ç¼é›†æˆ**: `add` å’Œ `remove` å‘½ä»¤ä¼šè‡ªåŠ¨ã€å®‰å…¨åœ°æ›´æ–°ä½ æœ¬åœ°çš„ `~/.kube/config` æ–‡ä»¶ï¼ŒåŒ…æ‹¬å¤‡ä»½å’Œæ¢å¤ã€‚
- **âš¡ï¸ é›¶åœæœºçƒ­åŠ è½½**: æ·»åŠ æˆ–åˆ é™¤é›†ç¾¤åï¼Œåªéœ€æ‰§è¡Œ `reload` å‘½ä»¤å³å¯åŠ¨æ€æ›´æ–°æœåŠ¡é…ç½®ï¼ŒAPI æœåŠ¡å…¨ç¨‹ä¸ä¸­æ–­ã€‚
- **ğŸ› ï¸ å¼ºå¤§çš„å‘½ä»¤è¡Œå·¥å…·é“¾**: ä½¿ç”¨ `cobra` æ„å»ºäº†å®Œæ•´ã€æ˜“ç”¨çš„ CLIï¼Œè¦†ç›–äº†ä»æœåŠ¡ç®¡ç†åˆ°é…ç½®çš„æ‰€æœ‰æ–¹é¢ã€‚
- **ğŸ”’ é»˜è®¤å®‰å…¨**: å¼ºåˆ¶ä½¿ç”¨ HTTPSï¼Œå¹¶è‡ªåŠ¨ä¸ºå®¢æˆ·ç«¯é…ç½® CA ä¿¡ä»»ï¼Œé¿å…ä¸å®‰å…¨çš„è¿æ¥ã€‚

## æ¶æ„ç®€å›¾

`Kube-Gateway` çš„å·¥ä½œæµç¨‹éå¸¸ç®€å•ç›´æ¥ï¼š

```
+-----------+         +----------------------------+         +---------------------+
|           |         |                            |         |                     |
|  å¼€å‘è€…   |--(1)--> |   Kube-Gateway (HTTPS)     |--(3)--> |  åç«¯ K8s é›†ç¾¤ A   |
| (kubectl) |         |                            |         |                     |
+-----------+         |  - è®¤è¯ (æ£€æŸ¥ Token)       |         +---------------------+
                      |  - è·¯ç”± (æŸ¥æ‰¾å¯¹åº”é›†ç¾¤)     |
                      |  - ä»£ç† (è½¬å‘è¯·æ±‚)         |         +---------------------+
                      |                            |         |                     |
                      +----------------------------+--(4)--> |  åç«¯ K8s é›†ç¾¤ B   |
                                                             |                     |
                                                             +---------------------+
```
1.  **è®¤è¯è¯·æ±‚**: ç”¨æˆ·çš„ `kubectl` ä½¿ç”¨åŒ…å«ç‰¹å®š Token çš„ `kubeconfig` è¿æ¥åˆ° `Kube-Gateway`ã€‚
2.  **ç½‘å…³å¤„ç†**: ç½‘å…³éªŒè¯ Tokenï¼Œå¹¶æ ¹æ® Token æ‰¾åˆ°å¯¹åº”çš„åç«¯é›†ç¾¤ã€‚
3.  **å®‰å…¨è½¬å‘**: ç½‘å…³ä½¿ç”¨è‡ªå·±æŒæœ‰çš„å‡­è¯ï¼Œå°†è¯·æ±‚å®‰å…¨åœ°è½¬å‘ç»™çœŸæ­£çš„ K8s é›†ç¾¤ã€‚

## å®‰è£…

### ä½¿ç”¨é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶
å‰å¾€æœ¬é¡¹ç›®çš„ [Releases é¡µé¢](https://github.com/gitlayzer/kube-gateway/releases) ä¸‹è½½é€‚ç”¨äºä½ æ“ä½œç³»ç»Ÿçš„æœ€æ–°ç‰ˆæœ¬ã€‚

## è¯¦ç»†ä½¿ç”¨ä¸æµ‹è¯•æŒ‡å— (Linux)

æœ¬æŒ‡å—å°†ä»ä¸€ä¸ªçº¯å‡€çš„ Linux ç¯å¢ƒå¼€å§‹ï¼Œå¸¦ä½ å®Œæˆ `kube-gateway` çš„ç¼–è¯‘ã€éƒ¨ç½²å’Œæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½çš„ç«¯åˆ°ç«¯æµ‹è¯•ã€‚

### å‡†å¤‡å·¥ä½œ

#### 1. ç¯å¢ƒè¦æ±‚
- `Go` (1.24 æˆ–æ›´é«˜ç‰ˆæœ¬)
- `Docker`
- `kubectl`
- `kind`

#### 2. ç¼–è¯‘é¡¹ç›®
åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œç¼–è¯‘ã€‚
```bash
# å…‹éš†ä»“åº“
git clone https://github.com/gitlayzer/kube-gateway.git

# æˆ–è€…ç›´æ¥ä½¿ç”¨ go build
go build -o kube-gateway .

# ç¡®ä¿äºŒè¿›åˆ¶æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
chmod +x ./kube-gateway
```

#### 3. åˆ›å»ºæœ¬åœ°æµ‹è¯•é›†ç¾¤
æˆ‘ä»¬å°†ä½¿ç”¨ `kind` åˆ›å»ºä¸‰ä¸ªä¸´æ—¶çš„ Kubernetes é›†ç¾¤ç”¨äºæµ‹è¯•ã€‚
```bash
# åˆ›å»º dev, staging, prod ä¸‰ä¸ªé›†ç¾¤
kind create cluster --name dev
kind create cluster --name staging
kind create cluster --name prod

# å¯¼å‡ºå®ƒä»¬çš„ kubeconfig æ–‡ä»¶åˆ°ä¸»ç›®å½•
kind get kubeconfig --name dev > ~/dev.config
kind get kubeconfig --name staging > ~/staging.config
kind get kubeconfig --name prod > ~/prod.config
```

### ç«¯åˆ°ç«¯æµ‹è¯•æµç¨‹

#### æ­¥éª¤ 1: é¦–æ¬¡å¯åŠ¨ä¸åŸºç¡€éªŒè¯

1.  **å¯åŠ¨æœåŠ¡**
    æ‰“å¼€ **ç»ˆç«¯1**ï¼Œåœ¨åå°å¯åŠ¨ `kube-gateway` æœåŠ¡ï¼Œå¹¶å°†æ—¥å¿—è¾“å‡ºåˆ° `gateway.log`ã€‚
    ```bash
    nohup ./kube-gateway serve > gateway.log 2>&1 &
    ```

2.  **éªŒè¯æœåŠ¡çŠ¶æ€**
    æ£€æŸ¥æ—¥å¿—å’Œè‡ªåŠ¨ç”Ÿæˆçš„ç›®å½•ã€‚
    ```bash
    # æŸ¥çœ‹å®æ—¶æ—¥å¿—
    tail -f gateway.log
    ```
    **é¢„æœŸç»“æœ**: ä½ åº”è¯¥èƒ½çœ‹åˆ°æ—¥å¿—æ˜¾ç¤ºæœåŠ¡æ­£åœ¨è‡ªåŠ¨ç”Ÿæˆ TLS è¯ä¹¦ï¼Œå¹¶æˆåŠŸå¯åŠ¨ã€‚
    ```
    æœªæ‰¾åˆ° TLS è¯ä¹¦ï¼Œæ­£åœ¨è‡ªåŠ¨ç”Ÿæˆæ–°çš„è¯ä¹¦...
    âœ… æˆåŠŸç”Ÿæˆå¹¶ä¿å­˜è¯ä¹¦åˆ° /home/user/.kube-gateway/certs/server.pem ...
    é…ç½®åŠ è½½å®Œæ¯•ã€‚å½“å‰æœ‰ 0 ä¸ªé›†ç¾¤ä»£ç†å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚
    æ­£åœ¨å¯åŠ¨ kube-gateway HTTPS æœåŠ¡å™¨äº 0.0.0.0:8443 (PID: 12345)
    ```
    ä½¿ç”¨ `ls -R ~/.kube-gateway` å¯ä»¥çœ‹åˆ° `certs` å’Œ `pid` ç›®å½•å·²è¢«åˆ›å»ºã€‚

#### æ­¥éª¤ 2: æ·»åŠ å¹¶æ¿€æ´»ç¬¬ä¸€ä¸ªé›†ç¾¤

1.  **æµ‹è¯• `add` å‘½ä»¤**
    åœ¨ **ç»ˆç«¯2** ä¸­æ·»åŠ  `dev` é›†ç¾¤ã€‚
    ```bash
    ./kube-gateway add dev ~/dev.config
    ```
    **é¢„æœŸç»“æœ**: æç¤ºæœåŠ¡ç«¯é…ç½®æˆåŠŸï¼Œå¹¶è‡ªåŠ¨æ›´æ–°äº†æœ¬åœ° `~/.kube/config`ã€‚

2.  **æµ‹è¯• `list` å‘½ä»¤**
    ```bash
    ./kube-gateway list
    ```
    **é¢„æœŸç»“æœ**: åˆ—å‡º `dev` é›†ç¾¤å’Œéƒ¨åˆ† Token ä¿¡æ¯ã€‚
    ```
    CONFIGURED CLUSTERS:
      - dev (Token: ...xxxxxxxx)
    ```

3.  **æµ‹è¯• `kubectl` (çƒ­åŠ è½½å‰)**
    æ­¤æ—¶æœåŠ¡å†…å­˜ä¸­è¿˜æ²¡æœ‰æ–°é›†ç¾¤çš„é…ç½®ï¼Œè¯·æ±‚åº”è¯¥ä¼šå¤±è´¥ã€‚
    ```bash
    kubectl get nodes
    ```
    **é¢„æœŸç»“æœ**: **å¤±è´¥**ï¼Œå¹¶æŠ¥é”™ `401 Unauthorized`ã€‚

4.  **æµ‹è¯• `reload` å‘½ä»¤**
    é€šçŸ¥æœåŠ¡åŠ è½½æ–°é…ç½®ã€‚
    ```bash
    ./kube-gateway reload
    ```
    **é¢„æœŸç»“æœ**: æç¤º `SIGHUP` ä¿¡å·å·²å‘é€ã€‚å›åˆ° **ç»ˆç«¯1** æŸ¥çœ‹ `gateway.log`ï¼Œåº”è¯¥èƒ½çœ‹åˆ°æ—¥å¿—æ˜¾ç¤ºâ€œæ”¶åˆ° SIGHUP ä¿¡å·â€å¹¶ä¸”â€œ1 ä¸ªé›†ç¾¤ä»£ç†å¤„äºæ´»åŠ¨çŠ¶æ€â€ã€‚

5.  **æµ‹è¯• `kubectl` (çƒ­åŠ è½½å)**
    å†æ¬¡å°è¯•è®¿é—®ã€‚
    ```bash
    kubectl get nodes
    ```
    **é¢„æœŸç»“æœ**: **æˆåŠŸ**ï¼Œå¹¶æ˜¾ç¤º `dev-control-plane` èŠ‚ç‚¹çš„ä¿¡æ¯ã€‚

#### æ­¥éª¤ 3: ç®¡ç†å¤šä¸ªé›†ç¾¤

1.  **æ·»åŠ ç¬¬äºŒä¸ªé›†ç¾¤**
    åœ¨ **ç»ˆç«¯2** ä¸­æ·»åŠ  `staging` é›†ç¾¤å¹¶é‡è½½ã€‚
    ```bash
    ./kube-gateway add staging ~/staging.config
    ./kube-gateway reload
    ```

2.  **éªŒè¯ `list` å‘½ä»¤**
    ```bash
    ./kube-gateway list
    ```
    **é¢„æœŸç»“æœ**: `dev` å’Œ `staging` ä¸¤ä¸ªé›†ç¾¤éƒ½è¢«åˆ—å‡ºã€‚

3.  **éªŒè¯å¤šé›†ç¾¤è®¿é—®**
    ä½¿ç”¨ `kubectl` åˆ‡æ¢ä¸Šä¸‹æ–‡å¹¶è®¿é—® `staging` é›†ç¾¤ã€‚
    ```bash
    # kubectl ä¼šè‡ªåŠ¨çŸ¥é“è¿™ä¸ªæ–°ä¸Šä¸‹æ–‡
    kubectl config use-context gateway-staging
    kubectl get nodes
    ```
    **é¢„æœŸç»“æœ**: **æˆåŠŸ**ï¼Œå¹¶æ˜¾ç¤º `staging-control-plane` èŠ‚ç‚¹çš„ä¿¡æ¯ã€‚

#### æ­¥éª¤ 4: ç§»é™¤é›†ç¾¤

1.  **æµ‹è¯• `remove` å‘½ä»¤**
    æˆ‘ä»¬å°†ç§»é™¤ `dev` é›†ç¾¤ã€‚
    ```bash
    ./kube-gateway remove dev
    ```
    **é¢„æœŸç»“æœ**: æç¤ºæœåŠ¡ç«¯é…ç½®å·²ç§»é™¤ï¼Œå¹¶è‡ªåŠ¨æ¸…ç†äº†æœ¬åœ° `~/.kube/config`ã€‚

2.  **éªŒè¯ `list` å’Œ `kubectl`**
    ```bash
    # list å‘½ä»¤ä¸­åº”è¯¥åªå‰©ä¸‹ staging
    ./kube-gateway list

    # å°è¯•æŸ¥çœ‹å·²åˆ é™¤çš„ dev ä¸Šä¸‹æ–‡
    kubectl config get-contexts | grep gateway-dev
    ```
    **é¢„æœŸç»“æœ**: `list` å‘½ä»¤åªæ˜¾ç¤º `staging` é›†ç¾¤ã€‚`get-contexts` å‘½ä»¤æ‰¾ä¸åˆ° `gateway-dev` ä¸Šä¸‹æ–‡ã€‚

3.  **æµ‹è¯•çƒ­åŠ è½½**
    ```bash
    ./kube-gateway reload
    ```
    æŸ¥çœ‹ **ç»ˆç«¯1** çš„æ—¥å¿—ï¼Œåº”è¯¥èƒ½çœ‹åˆ°â€œ1 ä¸ªé›†ç¾¤ä»£ç†å¤„äºæ´»åŠ¨çŠ¶æ€â€ã€‚

4.  **æœ€ç»ˆéªŒè¯**
    è®¿é—® `staging` é›†ç¾¤åº”è¯¥ä»ç„¶æ­£å¸¸ã€‚
    ```bash
    kubectl get nodes --context=gateway-staging
    ```
    **é¢„æœŸç»“æœ**: **æˆåŠŸ**ã€‚è¿™è¯æ˜ç§»é™¤ä¸€ä¸ªé›†ç¾¤ä¸ä¼šå½±å“å…¶ä»–é›†ç¾¤ã€‚

#### æ­¥éª¤ 5: æ¸…ç†å·¥ä½œ

æµ‹è¯•å®Œæˆåï¼Œæ¸…ç†æ‰€æœ‰èµ„æºã€‚

1.  **åœæ­¢æœåŠ¡**
    ```bash
    # è¯»å– PID æ–‡ä»¶å¹¶åœæ­¢è¿›ç¨‹
    kill $(cat ~/.kube-gateway/pid/kube-gateway.pid)
    ```
2.  **åˆ é™¤ `kind` é›†ç¾¤**
    ```bash
    kind delete clusters dev staging prod
    ```
3.  **åˆ é™¤æ‰€æœ‰é…ç½®æ–‡ä»¶**
    ```bash
    rm ~/dev.config ~/staging.config ~/prod.config
    rm -rf ~/.kube-gateway
    # åˆ«å¿˜äº†æ¢å¤ä½ ä¹‹å‰çš„ kubeconfig (å¦‚æœæœ‰å¤‡ä»½)
    # mv ~/.kube/config.bak ~/.kube/config
    ```

## å‘½ä»¤è¯¦è§£

#### `serve`
å¯åŠ¨ API ç½‘å…³ä¸»æœåŠ¡ã€‚
```bash
kube-gateway serve
```

#### `add <é›†ç¾¤åç§°> <kubeconfigè·¯å¾„>`
æ·»åŠ ä¸€ä¸ªæ–°çš„é›†ç¾¤é…ç½®ï¼Œå¹¶è‡ªåŠ¨æ›´æ–°æœ¬åœ° `~/.kube/config`ã€‚
```bash
kube-gateway add my-cluster /path/to/my-cluster.config
```

#### `list`
åˆ—å‡ºæ‰€æœ‰å·²ç”± `kube-gateway` ç®¡ç†çš„é›†ç¾¤ã€‚
```bash
kube-gateway list
```

#### `remove <é›†ç¾¤åç§°>`
ç§»é™¤ä¸€ä¸ªé›†ç¾¤é…ç½®ï¼Œå¹¶è‡ªåŠ¨æ¸…ç†æœ¬åœ° `~/.kube/config` ä¸­ç›¸å…³çš„æ¡ç›®ã€‚
```bash
kube-gateway remove my-cluster
```

#### `reload`
é€šçŸ¥æ­£åœ¨è¿è¡Œçš„ `serve` è¿›ç¨‹çƒ­åŠ è½½æœ€æ–°çš„é›†ç¾¤é…ç½®ï¼ŒæœåŠ¡ä¸ä¸­æ–­ã€‚
```bash
kube-gateway reload
```

## å»ºè®®
åœ¨ç”Ÿäº§ç¯å¢ƒçš„ Linux æœåŠ¡å™¨ä¸Šï¼Œå»ºè®®ä½¿ç”¨ `systemd` æ¥ç®¡ç†æœåŠ¡ã€‚