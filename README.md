# Kube-Gateway

**ä¸€ä¸ªé›†ä¸­çš„ã€é›¶é…ç½®çš„ Kubernetes API ç½‘å…³ï¼Œæ—¨åœ¨ç®€åŒ–å¤šé›†ç¾¤ç®¡ç†ã€‚**

`Kube-Gateway` æä¾›ä¸€ä¸ªç»Ÿä¸€ã€å®‰å…¨çš„ API å…¥å£ï¼Œè®©å¼€å‘è€…å’Œè¿ç»´äººå‘˜å¯ä»¥ä½¿ç”¨å•ä¸€çš„ã€è‡ªåŠ¨ç®¡ç†çš„ `kubeconfig` æ–‡ä»¶ï¼Œæ— ç¼åœ°è®¿é—®å’Œæ“ä½œæ‰€æœ‰å·²æˆæƒçš„ Kubernetes é›†ç¾¤ã€‚

## ç›®å½•

- [èƒŒæ™¯](#èƒŒæ™¯)
- [æ ¸å¿ƒç‰¹æ€§](#æ ¸å¿ƒç‰¹æ€§)
- [æ¶æ„ç®€å›¾](#æ¶æ„ç®€å›¾)
- [å®‰è£…](#å®‰è£…)
- [è¯¦ç»†ä½¿ç”¨ä¸æµ‹è¯•æŒ‡å— (Linux)](#è¯¦ç»†ä½¿ç”¨ä¸æµ‹è¯•æŒ‡å—-linux)
- [å‘½ä»¤è¯¦è§£](#å‘½ä»¤è¯¦è§£)

## èƒŒæ™¯

éšç€äº‘åŸç”ŸæŠ€æœ¯çš„å‘å±•ï¼Œåœ¨å¼€å‘å’Œç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨æ•°åä¸ªç”šè‡³ä¸Šç™¾ä¸ª Kubernetes é›†ç¾¤å·²æˆä¸ºå¸¸æ€ã€‚ç®¡ç†è¿™äº›é›†ç¾¤çš„è®¿é—®å‡­è¯ (`kubeconfig`) å˜å¾—æ—¥ç›Šå¤æ‚å’Œæ··ä¹±ï¼š
- å¼€å‘è€…éœ€è¦åœ¨æœ¬åœ°ç»´æŠ¤å¤§é‡é…ç½®æ–‡ä»¶ã€‚
- è½®æ¢å¯†é’¥å’Œæ›´æ–°å‡­è¯æˆä¸ºä¸€é¡¹ç¹é‡ä¸”æ˜“é”™çš„ä»»åŠ¡ã€‚
- æ— æ³•å¯¹æ‰€æœ‰é›†ç¾¤çš„è®¿é—®è¿›è¡Œç»Ÿä¸€çš„å®¡è®¡å’Œæ§åˆ¶ã€‚

`Kube-Gateway` çš„è¯ç”Ÿå°±æ˜¯ä¸ºäº†è§£å†³è¿™äº›ç—›ç‚¹ã€‚

## æ ¸å¿ƒç‰¹æ€§

- **ğŸš€ ç»Ÿä¸€è®¿é—®å…¥å£**: æ‰€æœ‰ `kubectl` è¯·æ±‚éƒ½æŒ‡å‘åŒä¸€ä¸ªç½‘å…³åœ°å€ï¼Œç”±ç½‘å…³æ™ºèƒ½è·¯ç”±åˆ°åç«¯å¯¹åº”çš„é›†ç¾¤ã€‚
- **âš™ï¸ é›¶é…ç½®å¯åŠ¨**: é¦–æ¬¡å¯åŠ¨æœåŠ¡æ—¶ï¼Œè‡ªåŠ¨ç”Ÿæˆæ‰€éœ€çš„ TLS è¯ä¹¦ï¼Œæ— éœ€ä»»ä½•æ‰‹åŠ¨ `openssl` æ“ä½œã€‚
- **ğŸ¤ å®¢æˆ·ç«¯æ— ç¼é›†æˆ**: `add` å’Œ `remove` å‘½ä»¤ä¼šè‡ªåŠ¨ã€å®‰å…¨åœ°æ›´æ–°ä½ æœ¬åœ°çš„ `~/.kube/config` æ–‡ä»¶ï¼ŒåŒ…æ‹¬å¤‡ä»½å’Œæ¢å¤ã€‚
- **âš¡ï¸ é›¶åœæœºçƒ­åŠ è½½**: æ·»åŠ æˆ–åˆ é™¤é›†ç¾¤åï¼Œåªéœ€æ‰§è¡Œ `reload` å‘½ä»¤å³å¯åŠ¨æ€æ›´æ–°æœåŠ¡é…ç½®ï¼ŒAPI æœåŠ¡å…¨ç¨‹ä¸ä¸­æ–­ã€‚
- **ğŸ› ï¸ å¼ºå¤§çš„å‘½ä»¤è¡Œå·¥å…·é“¾**: ä½¿ç”¨ `cobra` æ„å»ºäº†å®Œæ•´ã€æ˜“ç”¨çš„ CLIï¼Œè¦†ç›–äº†ä»æœåŠ¡ç®¡ç†åˆ°é…ç½®çš„æ‰€æœ‰æ–¹é¢ã€‚
- **ğŸ©º é›†ç¾¤å¥åº·æ¢æµ‹**: å†…ç½® `health` å‘½ä»¤ï¼Œå¯å¹¶å‘æ£€æŸ¥æ‰€æœ‰çº³ç®¡é›†ç¾¤çš„è¿é€šæ€§ã€K8s ç‰ˆæœ¬å’Œ API å»¶è¿Ÿã€‚
- **ğŸ¯ ç›´æ¥å‘½ä»¤ä»£ç†**: ç‹¬åˆ› `exec` å‘½ä»¤ï¼Œæ— éœ€åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼Œå³å¯åœ¨æŒ‡å®šé›†ç¾¤ä¸Šå¿«é€Ÿæ‰§è¡Œä»»ä½• `kubectl` æˆ– `helm` å‘½ä»¤ã€‚
- **ğŸ”’ é»˜è®¤å®‰å…¨**: å¼ºåˆ¶ä½¿ç”¨ HTTPSï¼Œå¹¶è‡ªåŠ¨ä¸ºå®¢æˆ·ç«¯é…ç½® CA ä¿¡ä»»ï¼Œé¿å…ä¸å®‰å…¨çš„è¿æ¥ã€‚

## æ¶æ„ç®€å›¾

`Kube-Gateway` çš„å·¥ä½œæµç¨‹éå¸¸ç®€å•ç›´æ¥ï¼š

![image.png](https://image.devops-engineer.com.cn/file/1756026304579_image.png)


1. **è®¤è¯è¯·æ±‚**: ç”¨æˆ·çš„ `kubectl` ä½¿ç”¨åŒ…å«ç‰¹å®š Token çš„ `kubeconfig` è¿æ¥åˆ° `Kube-Gateway`ã€‚
2. **ç½‘å…³å¤„ç†**: ç½‘å…³éªŒè¯ Tokenï¼Œå¹¶æ ¹æ® Token æ‰¾åˆ°å¯¹åº”çš„åç«¯é›†ç¾¤ã€‚
3. **å®‰å…¨è½¬å‘**: ç½‘å…³ä½¿ç”¨è‡ªå·±æŒæœ‰çš„å‡­è¯ï¼Œå°†è¯·æ±‚å®‰å…¨åœ°è½¬å‘ç»™çœŸæ­£çš„ K8s é›†ç¾¤ã€‚

## å®‰è£…

### ä½¿ç”¨é¢„ç¼–è¯‘çš„äºŒè¿›åˆ¶æ–‡ä»¶

å‰å¾€æœ¬é¡¹ç›®çš„ [Releases é¡µé¢](https://github.com/gitlayzer/kube-gateway/releases) ä¸‹è½½é€‚ç”¨äºä½ æ“ä½œç³»ç»Ÿçš„æœ€æ–°ç‰ˆæœ¬ã€‚

## è¯¦ç»†ä½¿ç”¨ä¸æµ‹è¯•æŒ‡å— (Linux)

æœ¬æŒ‡å—å°†ä»ä¸€ä¸ªçº¯å‡€çš„ Linux ç¯å¢ƒå¼€å§‹ï¼Œå¸¦ä½ å®Œæˆ `kube-gateway` çš„ç¼–è¯‘ã€éƒ¨ç½²å’Œæ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½çš„ç«¯åˆ°ç«¯æµ‹è¯•ã€‚

### å‡†å¤‡å·¥ä½œ

#### 1. ç¯å¢ƒè¦æ±‚
- `Go` (1.24 æˆ–æ›´é«˜ç‰ˆæœ¬)
- `Docker`
- `kubectl`
- `kind`

#### 2. ç¼–è¯‘é¡¹ç›®
åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œç¼–è¯‘ã€‚
```bash
# å…‹éš†ä»“åº“
git clone [https://github.com/gitlayzer/kube-gateway.git](https://github.com/gitlayzer/kube-gateway.git)

# æˆ–è€…ç›´æ¥ä½¿ç”¨ go build
go build -o kube-gateway .

# ç¡®ä¿äºŒè¿›åˆ¶æ–‡ä»¶æœ‰æ‰§è¡Œæƒé™
chmod +x ./kube-gateway

3. åˆ›å»ºæœ¬åœ°æµ‹è¯•é›†ç¾¤
æˆ‘ä»¬å°†ä½¿ç”¨ kind åˆ›å»ºä¸‰ä¸ªä¸´æ—¶çš„ Kubernetes é›†ç¾¤ç”¨äºæµ‹è¯•ã€‚

# åˆ›å»º dev, staging, prod ä¸‰ä¸ªé›†ç¾¤
kind create cluster --name dev
kind create cluster --name staging
kind create cluster --name prod

# å¯¼å‡ºå®ƒä»¬çš„ kubeconfig æ–‡ä»¶åˆ°ä¸»ç›®å½•
kind get kubeconfig --name dev > ~/dev.config
kind get kubeconfig --name staging > ~/staging.config
kind get kubeconfig --name prod > ~/prod.config

ç«¯åˆ°ç«¯æµ‹è¯•æµç¨‹
æ­¥éª¤ 1: é¦–æ¬¡å¯åŠ¨ä¸åŸºç¡€éªŒè¯
å¯åŠ¨æœåŠ¡
æ‰“å¼€ ç»ˆç«¯1ï¼Œåœ¨åå°å¯åŠ¨ kube-gateway æœåŠ¡ï¼Œå¹¶å°†æ—¥å¿—è¾“å‡ºåˆ° gateway.logã€‚

nohup ./kube-gateway serve > gateway.log 2>&1 &

éªŒè¯æœåŠ¡çŠ¶æ€
æ£€æŸ¥æ—¥å¿—å’Œè‡ªåŠ¨ç”Ÿæˆçš„ç›®å½•ã€‚

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
tail -f gateway.log

é¢„æœŸç»“æœ: ä½ åº”è¯¥èƒ½çœ‹åˆ°æ—¥å¿—æ˜¾ç¤ºæœåŠ¡æ­£åœ¨è‡ªåŠ¨ç”Ÿæˆ TLS è¯ä¹¦ï¼Œå¹¶æˆåŠŸå¯åŠ¨ã€‚

æœªæ‰¾åˆ° TLS è¯ä¹¦ï¼Œæ­£åœ¨è‡ªåŠ¨ç”Ÿæˆæ–°çš„è¯ä¹¦...
âœ… æˆåŠŸç”Ÿæˆå¹¶ä¿å­˜è¯ä¹¦åˆ° /home/user/.kube-gateway/certs/server.pem ...
é…ç½®åŠ è½½å®Œæ¯•ã€‚å½“å‰æœ‰ 0 ä¸ªé›†ç¾¤ä»£ç†å¤„äºæ´»åŠ¨çŠ¶æ€ã€‚
æ­£åœ¨å¯åŠ¨ kube-gateway HTTPS æœåŠ¡å™¨äº 0.0.0.0:8443 (PID: 12345)

ä½¿ç”¨ ls -R ~/.kube-gateway å¯ä»¥çœ‹åˆ° certs å’Œ pid ç›®å½•å·²è¢«åˆ›å»ºã€‚

æ­¥éª¤ 2: æ·»åŠ å¹¶æ¿€æ´»é›†ç¾¤
æµ‹è¯• add å’Œ list å‘½ä»¤
åœ¨ ç»ˆç«¯2 ä¸­æ·»åŠ  dev å’Œ staging é›†ç¾¤ã€‚

./kube-gateway add dev ~/dev.config
./kube-gateway add staging ~/staging.config
./kube-gateway list

é¢„æœŸç»“æœ: list å‘½ä»¤ä¼šä»¥è¡¨æ ¼å½¢å¼åˆ—å‡º dev å’Œ staging ä¸¤ä¸ªé›†ç¾¤ã€‚

æµ‹è¯• reload å‘½ä»¤
é€šçŸ¥æœåŠ¡åŠ è½½æ–°é…ç½®ã€‚

./kube-gateway reload

é¢„æœŸç»“æœ: æç¤º SIGHUP ä¿¡å·å·²å‘é€ã€‚å›åˆ° ç»ˆç«¯1 æŸ¥çœ‹ gateway.logï¼Œåº”è¯¥èƒ½çœ‹åˆ°æ—¥å¿—æ˜¾ç¤ºâ€œæ”¶åˆ° SIGHUP ä¿¡å·â€å¹¶ä¸”â€œ2 ä¸ªé›†ç¾¤ä»£ç†å¤„äºæ´»åŠ¨çŠ¶æ€â€ã€‚

æµ‹è¯• kubectl (çƒ­åŠ è½½å)
add å‘½ä»¤å·²è‡ªåŠ¨å°† kubectl ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ°æœ€æ–°æ·»åŠ çš„ gateway-stagingã€‚

kubectl get nodes

é¢„æœŸç»“æœ: æˆåŠŸï¼Œå¹¶æ˜¾ç¤º staging-control-plane èŠ‚ç‚¹çš„ä¿¡æ¯ã€‚

æ­¥éª¤ 3: æµ‹è¯• health å’Œ exec å‘½ä»¤
æµ‹è¯• health å‘½ä»¤
åœ¨ ç»ˆç«¯2 ä¸­è¿è¡Œå¥åº·æ£€æŸ¥ã€‚

./kube-gateway health

é¢„æœŸç»“æœ: è¾“å‡ºä¸€ä¸ªè¡¨æ ¼ï¼Œæ˜¾ç¤º dev å’Œ staging é›†ç¾¤çš„çŠ¶æ€ä¸º âœ… UPã€‚

æµ‹è¯• exec å‘½ä»¤
æ— éœ€åˆ‡æ¢ä¸Šä¸‹æ–‡ï¼Œç›´æ¥åœ¨ dev é›†ç¾¤ä¸Šæ‰§è¡Œå‘½ä»¤ã€‚

./kube-gateway exec dev -- kubectl get pods -n kube-system

é¢„æœŸç»“æœ: æˆåŠŸï¼Œå¹¶åˆ—å‡º dev é›†ç¾¤ kube-system å‘½åç©ºé—´ä¸‹çš„ Podsã€‚ä½ å½“å‰çš„ kubectl ä¸Šä¸‹æ–‡ï¼ˆgateway-stagingï¼‰ä¿æŒä¸å˜ã€‚

æ­¥éª¤ 4: ç§»é™¤é›†ç¾¤
æµ‹è¯• remove å‘½ä»¤
æˆ‘ä»¬å°†ç§»é™¤ dev é›†ç¾¤ã€‚

./kube-gateway remove dev
./kube-gateway reload

é¢„æœŸç»“æœ: æç¤ºæœåŠ¡ç«¯é…ç½®å·²ç§»é™¤ï¼Œå¹¶è‡ªåŠ¨æ¸…ç†äº†æœ¬åœ° ~/.kube/configã€‚

æœ€ç»ˆéªŒè¯
list å‘½ä»¤ä¸­åº”è¯¥åªå‰©ä¸‹ staging é›†ç¾¤ï¼Œä¸”è®¿é—® staging é›†ç¾¤åº”è¯¥ä»ç„¶æ­£å¸¸ã€‚

./kube-gateway list
kubectl get nodes --context=gateway-staging

é¢„æœŸç»“æœ: æˆåŠŸã€‚

æ­¥éª¤ 5: æ¸…ç†å·¥ä½œ
æµ‹è¯•å®Œæˆåï¼Œæ¸…ç†æ‰€æœ‰èµ„æºã€‚

åœæ­¢æœåŠ¡

# è¯»å– PID æ–‡ä»¶å¹¶åœæ­¢è¿›ç¨‹
kill $(cat ~/.kube-gateway/pid/kube-gateway.pid)

åˆ é™¤ kind é›†ç¾¤

kind delete clusters dev staging prod

åˆ é™¤æ‰€æœ‰é…ç½®æ–‡ä»¶

rm ~/dev.config ~/staging.config ~/prod.config
rm -rf ~/.kube-gateway
# åˆ«å¿˜äº†æ¢å¤ä½ ä¹‹å‰çš„ kubeconfig (å¦‚æœæœ‰å¤‡ä»½)
# mv ~/.kube/config.bak ~/.kube/config
```

## å‘½ä»¤è¯¦è§£
```bash
serve
å¯åŠ¨ API ç½‘å…³ä¸»æœåŠ¡ã€‚

kube-gateway serve

add <é›†ç¾¤åç§°> <kubeconfigè·¯å¾„>
æ·»åŠ ä¸€ä¸ªæ–°çš„é›†ç¾¤é…ç½®ï¼Œå¹¶è‡ªåŠ¨æ›´æ–°æœ¬åœ° ~/.kube/configã€‚

kube-gateway add my-cluster /path/to/my-cluster.config

list
ä»¥è¡¨æ ¼å½¢å¼åˆ—å‡ºæ‰€æœ‰å·²ç”± kube-gateway ç®¡ç†çš„é›†ç¾¤åŠå…¶è¯¦ç»†ä¿¡æ¯ã€‚

kube-gateway list

remove <é›†ç¾¤åç§°>
ç§»é™¤ä¸€ä¸ªé›†ç¾¤é…ç½®ï¼Œå¹¶è‡ªåŠ¨æ¸…ç†æœ¬åœ° ~/.kube/config ä¸­ç›¸å…³çš„æ¡ç›®ã€‚

kube-gateway remove my-cluster

reload
é€šçŸ¥æ­£åœ¨è¿è¡Œçš„ serve è¿›ç¨‹çƒ­åŠ è½½æœ€æ–°çš„é›†ç¾¤é…ç½®ï¼ŒæœåŠ¡ä¸ä¸­æ–­ã€‚

kube-gateway reload

health
å¹¶å‘æ£€æŸ¥æ‰€æœ‰å·²é…ç½®é›†ç¾¤çš„ API Server è¿é€šæ€§ã€K8s ç‰ˆæœ¬å’Œå»¶è¿Ÿã€‚

kube-gateway health

exec <é›†ç¾¤åç§°> -- <å‘½ä»¤...>
åœ¨æŒ‡å®šé›†ç¾¤ä¸Šæ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œè€Œæ— éœ€åˆ‡æ¢æœ¬åœ°çš„ kubectl ä¸Šä¸‹æ–‡ã€‚ä½¿ç”¨ -- æ¥åˆ†éš” exec å‘½ä»¤å’Œè¦æ‰§è¡Œçš„å‘½ä»¤ã€‚

# åœ¨ dev é›†ç¾¤ä¸Šè·å– pods
kube-gateway exec dev -- kubectl get pods

# åœ¨ staging é›†ç¾¤ä¸Šåˆ—å‡º helm charts
kube-gateway exec staging -- helm list -n default
```